<!DOCTYPE html>
<html>
    <head>
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel ="stylesheet" href="index.css">

        <script src = "fabric.min.js"></script>
        <script src = "fileSaver.js"></script>
        <!-- <script src = "fb.js" type="text/javascript"></script> -->
    
   
        <title>welcome to automata </title>

    </head>

    <body>
        <nav class="navbar navbar-dark bg-dark" id="nav">
            <a color="white">CISC 475</a>
            <div id="button_div">
                <button id="addState" type="button" onclick="addState()" class="btn btn-dark">add state</button>
                <button id="addAcceptState" type="button" onclick="addAcceptState()" class="btn btn-dark">add Accept State</button>
                <button type="button" onclick="document.getElementById('modal-create').style.display='block'" class="btn btn-dark">add transition</button>
                <button type="button" onclick="run()" class="btn btn-dark">run</button>
                <button type="button" onclick="clearCanvas()"class="btn btn-danger">delete</button>
            </div>
            
            <div id="modal-create" class="modal" align="center">
                <div class="modal-content">
                  <h4 text-align="center">Create transition</h4>
                    <div class="input-field">
                        <label for="start">from</label>
                        <input type= "text" id = "start" placeholder="enter state number" required><br/>
                        <label for="end">to</label>
                        <input type= "text" id = "end" placeholder="enter state number" required><br/>
                        <label for="input">input</label>
                        <input type= "text" id = "input" placeholder="enter path" required>
                        <button class="btn btn-outline-success my-2 my-sm-0" onclick="addArrow()">add transition</button>
                    </div>
                <div class="container" style="background-color:#f1f1f1">
                  <button type="button" onclick="document.getElementById('modal-create').style.display='none'" class="cancelbtn">Cancel</button>
                    </div>
                </div>
              </div> 

            
            <div class="dropdown">
                <button onclick="f()" class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Menu
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="#">save</a>
                <a class="dropdown-item" href="#">upload</a>
                </div>
            </div>
        </nav>

            <canvas id="canvas" width ="1200" height="477"></canvas>

             <script>

                var stateimgURL = 'circle2.svg';
                var c = document.querySelector("canvas");
                var canvas = new fabric.Canvas('canvas');
               

                var arrowimgURL = "arrow1.png";
                var arrow = new Image();
                //var state = new Image();
                var statenum = 0;

                var states = [];
                var transitions = [];
                
            
                
                function addState()
                {
                    document.getElementById("addState").disabled = true;
                    document.getElementById("addAcceptState").disabled = true;
                    document.body.style.cursor = "pointer";

                    canvas.on('mouse:down', function(options) {
                        drawState(options); 
                        
                    });
                    document.body.style.cursor = "pointer";
               
                }

                function addAcceptState()
                {
                    document.getElementById("addState").disabled = true;
                    document.getElementById("addAcceptState").disabled = true;
                    document.body.style.cursor = "pointer";

                    canvas.on('mouse:down', function(options) {
                        drawAcceptState(options); 
                        
                    });
                    document.body.style.cursor = "pointer";
               
                }

                function drawAcceptState(event)
                {
                    let x = event.e.clientX; 
                    let y = event.e.clientY;

                    console.log(x,y)
                    canvas.off();

                    var c1 = new fabric.Circle({
                       
                       strokeWidth: 5,
                       radius: 40,
                       fill: '#fff',
                       stroke: 'black',
                       left: x-60,
                       top: y-120,
                       
                   });

                   var c2 = new fabric.Circle({
                       
                       strokeWidth: 3,
                       radius: 50,
                       fill: '#fff',
                       stroke: 'black',
                       left: x-69,
                       top: y-128,
                       
                   });

                   var text = new fabric.Text('Q'+statenum, { 
                        left: c1.left+20,
                        top: c1.top+20, 
                        fill: 'black'
                    });

                    var group = new fabric.Group([ c2, c1, text ], {
                        left: c1.left,
                        top: c1.top,
                    })

                    var state = {
                        "x": c1.left,
                        "y": c1.top,
                        "statenum": statenum,
                        "acceptState": true
                        
                    }

                    statenum++;

                    states.push(state);
                    canvas.add(group);

                    for(i in states)
                    {
                        console.log(states[i]);
                    }
                   
                    document.getElementById("addState").disabled = false;
                    document.getElementById("addAcceptState").disabled = false;

                }


                function drawState(event)
                { 
                    
                    let x = event.e.clientX; 
                    let y = event.e.clientY;
                    console.log(x,y)
                    canvas.off();

                    var state = {
                        
                    }
                    
                    var temp = new fabric.Circle({
                       
                        strokeWidth: 5,
                        radius: 40,
                        fill: '#fff',
                        stroke: 'black',
                        left: x-60,
                        top: y-120,
                        
                    });

                    var state = {
                        "x": temp.left,
                        "y": temp.top,
                        "statenum": statenum,
                        "acceptState": false
                        
                    }

                    states.push(state);
                                  
                    var text = new fabric.Text('Q'+statenum, { 
                        left: temp.left+20,
                        top: temp.top+20, 
                        fill: 'black'
                    });

                    var group = new fabric.Group([ temp, text ], {
                        left: temp.left,
                        top: temp.top,
                    });
                 
                    canvas.add(group);

                    statenum++;
                    document.body.style.cursor = "default";

                    document.getElementById("addState").disabled = false;
                    document.getElementById("addAcceptState").disabled = false;

                    for(i in states)
                    {
                        console.log(states[i]);
                    }

                };

                function addArrow()
                { 
                    //var input = window.prompt("enter their relation","");
                    var SS = document.getElementById("start").value;
                    var ES = document.getElementById("end").value;
                    var input = document.getElementById("input").value;

                    var t = {
                        "from":SS,
                        "to":ES,
                        "input":input
                    }

                    transitions.push(t);
                    
                    for(var i=0; i<transitions.length; i++)
                    {
                        console.log(transitions[i]);
                    }

                    document.getElementById("modal-create").style.display=("none");

                    console.log(SS,ES,input);
                    var temp = new fabric.Image(arrow, {
                        angle: 0,
                        width: 1280,
                        height: 640,
                        left: 50,
                        top: 70,
                        scaleX: .2,
                        scaleY: .2,
                      
                    });

                    var text = new fabric.Text(input,{
                        left: temp.left+100,
                        top: temp.top+10,
                    });

                    var group = new fabric.Group([ temp, text ],{
                        top:100,
                        left: 100
                    });

                    canvas.add(group);
               
                };

                function run()
                {
                    var input = window.prompt("enter string","");
                    var result = true; 
                    var currentState=0;
                    var lastState;

                    for(var i=0; i<input.length; i++)
                    {
                        var found = 0;

                        for(var k in transitions)
                        {
                            // console.log(k);
                            // console.log(input.charAt(i));
                            // console.log(transitions[i].input); 

                            if(transitions[k].from === currentState)
                            {
                                if(input.charAt(i) === transitions[k].input)
                                {
                                    found = 1;
                                    currentState = transitions[k].to;

                                    if(i === input.length-1)
                                    {
                                        for(j in states)
                                        {
                                            if(states[j].statenum === currentState)
                                            {
                                                if( states[j].acceptState === false)
                                                    result = false;
                                            }
                                        }
                                    }
                                }

                            }
                        }

                        if(found === 0)
                        {
                            result = false;
                        }
                    }

                    if(result === false)
                        alert("false");
                    else if(result === true)
                        alert("true");
                }


                arrow.src = arrowimgURL;
               // state.src = stateimgURL;

            </script>  
 
            <!-- <svg width="100" height="100">
                <circle cx="50" cy="50" r="40" stroke="black" stroke-width="4" fill ="white" />
             </svg> -->
              
         
             <!-- <script src="test.js"></script>  -->
    </body>
</html>